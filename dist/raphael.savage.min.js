/*! raphael.savage 11-10-2014 */
var Savage=Savage||{};Savage.Arrow=function(a){this.start=new Savage.Point(-10,-10),this.stop=new Savage.Point(-100,-100),this.color="#ee0000",this.editor=a,this.paper=a.paper,this.raphaelobject=null,this.startSelector=null,this.stopSelector=null,this.resizing=!1,this.glow=null,this.selected=!1,this.path=function(){var a=this.stop.x-this.start.x,b=this.stop.y-this.start.y,c=Math.sqrt(a*a+b*b),d=Math.atan2(b,a),e=.3,f=.2,g=.4,h=.25,i=d-g,j=d-h,k=d+g,l=d+h,m=Math.floor(this.start.x+Math.cos(i)*c*e),n=Math.floor(this.start.y+Math.sin(i)*c*e),o=Math.floor(this.start.x+Math.cos(j)*c*f),p=Math.floor(this.start.y+Math.sin(j)*c*f),q=Math.floor(this.start.x+Math.cos(k)*c*e),r=Math.floor(this.start.y+Math.sin(k)*c*e),s=Math.floor(this.start.x+Math.cos(l)*c*f),t=Math.floor(this.start.y+Math.sin(l)*c*f);return"M"+this.start.x+" "+this.start.y+" L"+q+","+r+" L"+s+","+t+" L"+this.stop.x+" "+this.stop.y+" L"+o+","+p+" L"+m+","+n+" Z"},this.update=function(){this.raphaelobject.attr({path:this.path(),"stroke-width":2,stroke:this.selected?Savage.currenSelectedColor:this.color,fill:this.color}),this.selected?$(this.raphaelobject.node).attr("class","selectable selected"):$(this.raphaelobject.node).attr("class","selectable"),null!=this.glow&&this.glow.remove(),this.glow=this.raphaelobject.glow({width:5,fill:!1,opacity:.5,offsetx:1,offsety:1,color:"#000000"}),null!=this.startSelector&&this.startSelector.attr({cx:this.start.x,cy:this.start.y}),null!=this.stopSelector&&this.stopSelector.attr({cx:this.stop.x,cy:this.stop.y})},this.select=function(){this.editor.clearSelection(),this.selected=!0,console.log("selected!"),null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),this.startSelector=this.paper.circle(this.start.x,this.start.y,6).attr({fill:"#fff",stroke:"#00f"}),this.stopSelector=this.paper.circle(this.stop.x,this.stop.y,6).attr({fill:"#fff",stroke:"#00f"}),this.update();var a=this;this.startSelector.undrag(),this.startSelector.drag(function(b,c){a.start.x=this.data("ox")+b,a.start.y=this.data("oy")+c,a.update()},function(){this.data("ox",this.attr("cx")),this.data("oy",this.attr("cy")),Savage.mode="dragging"},function(){Savage.mode="none"}),this.stopSelector.undrag(),this.stopSelector.drag(function(b,c){a.stop.x=this.data("ox")+b,a.stop.y=this.data("oy")+c,a.update()},function(){this.data("ox",this.attr("cx")),this.data("oy",this.attr("cy")),Savage.mode="dragging"},function(){Savage.mode="none",console.log(Savage.mode)})},this.unselect=function(){console.log("unselected!"),this.selected=!1,null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),this.update()},this.draw=function(){this.raphaelobject=this.paper.path(this.path()),this.unselect();var a=this;this.raphaelobject.click(function(){console.log("raphaelobject on click"),a.select()}),this.raphaelobject.undrag(),this.raphaelobject.drag(function(b,c){a.start.x=this.data("startx")+b,a.start.y=this.data("starty")+c,a.stop.x=this.data("stopx")+b,a.stop.y=this.data("stopy")+c,a.update()},function(){this.data("startx",a.start.x),this.data("starty",a.start.y),this.data("stopx",a.stop.x),this.data("stopy",a.stop.y),Savage.mode="dragging"},function(){Savage.mode="none",console.log(Savage.mode)})},this.draw(),this.remove=function(){null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),null!=this.glow&&this.glow.remove(),this.raphaelobject.remove(),delete this},this.toJSON=function(){return{type:"arrow",start:this.start.toJSON(),stop:this.stop.toJSON(),color:this.color}},this.fromJSON=function(a){return this.start.fromJSON(a.start),this.stop.fromJSON(a.stop),this.color=a.color,this.update(),this}},Savage.FreeDraw=function(a){this.stop=null,this.start=new Savage.Point(0,0),this.paper=a.paper,this.raphaelobject=null,this.array=new Array,this.array[0]=["M",this.start.x,this.start.y],this.editor=a,this.selected=!1,this.color="#ee0000",this.translation=new Savage.Point(0,0),this.path=function(){return this.array[0]=["M",this.start.x,this.start.y],this.array},this.update=function(){null!=this.stop&&(this.array[this.array.length-1].x!==this.stop.x||this.array[this.array.length-1].y!==this.stop.y)&&(this.array[this.array.length]=["L",this.stop.x,this.stop.y],this.raphaelobject.attr({path:this.path(),"stroke-width":2,stroke:this.selected?Savage.currenSelectedColor:this.color,transform:["t",this.translation.x,this.translation.y]}),this.selected?$(this.raphaelobject.node).attr("class","selectable selected"):$(this.raphaelobject.node).attr("class","selectable"),null!=this.glow&&this.glow.remove(),this.glow=this.raphaelobject.glow({width:5,fill:!1,opacity:.5,offsetx:1,offsety:1,color:"#000000"}))},this.select=function(){this.editor.clearSelection(),this.selected=!0,console.log("freedraw selected"),this.update()},this.unselect=function(){console.log("unselected!"),this.selected=!1,this.update()},this.draw=function(){this.raphaelobject=this.paper.path(this.path()),this.unselect();var a=this;this.raphaelobject.click(function(){console.log("freedraw on click"),a.select()}),this.raphaelobject.undrag(),this.raphaelobject.drag(function(b,c){a.translation.x=this.data("translationx")+b,a.translation.y=this.data("translationy")+c,a.update()},function(){this.data("translationx",a.translation.x),this.data("translationy",a.translation.y),Savage.mode="dragging"},function(){Savage.mode="none",console.log(Savage.mode)})},this.remove=function(){null!=this.glow&&this.glow.remove(),this.raphaelobject.remove(),delete this},this.draw(),this.toJSON=function(){return{type:"freedraw",array:this.array,start:this.start.toJSON(),stop:this.stop.toJSON(),translation:this.translation.toJSON()}},this.fromJSON=function(a){return this.start.fromJSON(a.start),this.stop=new Savage.Point(0,0),this.stop.fromJSON(a.stop),this.array=JSON.parse(JSON.stringify(a.array)),this.translation.fromJSON(a.translation),this.update(),this}};var Savage=Savage||{};Savage.S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},Savage.uniqueID=function(){return Savage.S4()+Savage.S4()+"-"+Savage.S4()+Savage.S4()},Savage.currenSelectedColor="#ff0000",Savage.mode="none",Savage.Point=function(a,b){this.x=a,this.y=b,this.toJSON=function(){return{x:this.x,y:this.y}},this.fromJSON=function(a){this.x=a.x,this.y=a.y}};var Savage=Savage||{};Savage.Drawer=function(){this.tempObject=null,this.mode="none",this.startDrawing=function(a,b){this.tempObject.start=new Savage.Point(a,b),this.tempObject.stop=new Savage.Point(a,b),this.mode="drawing-line"},this.toClose=function(){return Math.sqrt(Math.pow(this.tempObject.start.x-this.tempObject.stop.x,2)+Math.pow(this.tempObject.start.y-this.tempObject.stop.y,2))<10},this.update=function(a,b){null!==this.tempObject&&(this.tempObject.stop=new Savage.Point(a,b),"drawing-line"!==this.mode||this.toClose()||this.tempObject.update())},this.finish=function(a){return a&&"drawing-line"===this.mode&&!this.toClose()?(this.mode="none",!0):(this.mode="none",this.tempObject=null,!1)}},Savage.Editor=function(a){this.objectList=new Array,this.id=Savage.uniqueID(),this.hasFocus=!1,this.mouseabove=!1,$("#"+a).html("    <div class='btn-group'>        <button id='svg-editor-"+this.id+"-add-arrow' type='button' class='btn btn-default'>Add arrow</button>        <button id='svg-editor-"+this.id+"-add-rectangle' type='button' class='btn btn-default'>Add rectangle</button>        <button id='svg-editor-"+this.id+"-add-freedraw' type='button' class='btn btn-default'>Add freedraw</button>        <button id='svg-editor-"+this.id+"-clear' type='button' class='btn btn-default'>Clear</button>    </div>    <div id='svg-editor-"+this.id+"' style='height: "+($("#"+a).height()-46)+"px;width:100%;border:solid #000 1px;'></div>"),this.paper=Raphael("svg-editor-"+this.id,"100%","100%");var b="none",c="none",d=new Savage.Drawer,e=this;$("#svg-editor-"+this.id+"-add-arrow").on("click",function(){b="add-arrow",d.tempObject=new Savage.Arrow(e),c="none"}),$("#svg-editor-"+this.id+"-add-rectangle").on("click",function(){b="add-rectangle",d.tempObject=new Savage.Rectangle(e),c="none"}),$("#svg-editor-"+this.id+"-add-text").on("click",function(){b="add-text",c="none"}),$("#svg-editor-"+this.id+"-add-freedraw").on("click",function(){b="add-freedraw",d.tempObject=new Savage.FreeDraw(e),c="none"}),$("#svg-editor-"+this.id+"-modify").on("click",function(){b="modify",c="none"}),$("#svg-editor-"+this.id+"-clear").on("click",function(){e.clearEditor()}),$("#svg-editor-"+this.id).on("vmousedown",function(a){if("dragging"!==Savage.mode&&1===a.which&&(console.log(this.id+" on mousedown"),console.log(Savage.mode),a.preventDefault(),"add-arrow"===b||"add-rectangle"===b||"add-freedraw"===b)){var c=$(this).offset();d.startDrawing(a.pageX-c.left,a.pageY-c.top)}}),$("#svg-editor-"+this.id).on("vmousemove",function(a){if("dragging"!==Savage.mode&&(a.preventDefault(),"add-arrow"===b||"add-rectangle"===b||"add-freedraw"===b)){var c=$(this).offset();d.update(a.pageX-c.left,a.pageY-c.top)}}),$(document).keydown(function(a){if(console.log(a),46==a.keyCode||8==a.keyCode){for(var b=0;b<e.objectList.length;b++)e.objectList[b].selected&&(e.objectList[b].remove(),delete e.objectList[b]);return e.objectList=e.objectList.filter(function(a){return void 0!=a}),a.preventDefault(),!1}}),$(document).click(function(){e.hasFocus=e.mouseabove,console.log("Has focus = "+e.hasFocus),e.hasFocus||e.clearSelection()}),$("#svg-editor-"+this.id).on("mouseenter",function(){console.log("enter control"),e.mouseabove=!0}),$("#svg-editor-"+this.id).on("mouseleave",function(){console.log("leave control"),e.mouseabove=!1}),$("#svg-editor-"+this.id).keyup(function(a){console.log("svg editor keyup"+a)}),$("#svg-editor-"+this.id).on("vmouseup",function(){if("dragging"!==Savage.mode){e.clearSelection();var a=e.objectList.length;"add-arrow"===b&&(d.finish("add-arrow"===b)&&(e.objectList[a]=d.tempObject),d.tempObject=new Savage.Arrow(e)),"add-rectangle"===b&&(d.finish("add-rectangle"===b)&&(e.objectList[a]=d.tempObject),d.tempObject=new Savage.Rectangle(e)),"add-freedraw"===b&&(d.finish("add-freedraw"===b)&&(e.objectList[a]=d.tempObject),d.tempObject=new Savage.FreeDraw(e))}}),this.saveToJSON=function(){var a={objects:[]};return this.objectList.forEach(function(b){a.objects.push(b.toJSON())}),a},this.loadFromJSON=function(a){var b=JSON.parse(a).objects,c=this;b.forEach(function(a){switch(a.type){case"arrow":c.objectList.push(new Savage.Arrow(c).fromJSON(a));break;case"rectangle":c.objectList.push(new Savage.Rectangle(c).fromJSON(a));break;case"freedraw":c.objectList.push(new Savage.FreeDraw(c).fromJSON(a))}})},this.clearSelection=function(){this.objectList.forEach(function(a){a.unselect()})},this.clearEditor=function(){console.log(e.objectList);for(var a=0;a<this.objectList.length;a++)this.objectList[a].remove();this.objectList=[]}},window.Savage=Savage,Savage.Rectangle=function(a){this.start=new Savage.Point(-10,-10),this.stop=new Savage.Point(-100,-100),this.paper=a.paper,this.raphaelobject=null,this.color="#ee0000",this.editor=a,this.startSelector=null,this.stopSelector=null,this.resizing=!1,this.glow=null,this.selected=!1,this.path=function(){return"M"+this.start.x+" "+this.start.y+" L"+this.stop.x+","+this.start.y+" L"+this.stop.x+" "+this.stop.y+" L"+this.start.x+","+this.stop.y+" Z"},this.update=function(){this.raphaelobject.attr({path:this.path(),"stroke-width":2,stroke:this.selected?Savage.currenSelectedColor:this.color}),this.selected?$(this.raphaelobject.node).attr("class","selectable selected"):$(this.raphaelobject.node).attr("class","selectable"),null!=this.glow&&this.glow.remove(),this.glow=this.raphaelobject.glow({width:5,fill:!1,opacity:.5,offsetx:1,offsety:1,color:"#000000"}),null!=this.startSelector&&this.startSelector.attr({cx:this.start.x,cy:this.start.y}),null!=this.stopSelector&&this.stopSelector.attr({cx:this.stop.x,cy:this.stop.y})},this.select=function(){this.editor.clearSelection(),this.selected=!0,console.log("selected!"),null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),this.startSelector=this.paper.circle(this.start.x,this.start.y,6).attr({fill:"#fff",stroke:"#00f"}),this.stopSelector=this.paper.circle(this.stop.x,this.stop.y,6).attr({fill:"#fff",stroke:"#00f"}),this.update();var a=this;this.startSelector.undrag(),this.startSelector.drag(function(b,c){a.start.x=this.data("ox")+b,a.start.y=this.data("oy")+c,a.update()},function(){this.data("ox",this.attr("cx")),this.data("oy",this.attr("cy")),Savage.mode="dragging"},function(){Savage.mode="none"}),this.stopSelector.undrag(),this.stopSelector.drag(function(b,c){a.stop.x=this.data("ox")+b,a.stop.y=this.data("oy")+c,a.update()},function(){this.data("ox",this.attr("cx")),this.data("oy",this.attr("cy")),Savage.mode="dragging"},function(){Savage.mode="none",console.log(Savage.mode)})},this.unselect=function(){console.log("unselected!"),this.selected=!1,null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),this.update()},this.draw=function(){this.raphaelobject=this.paper.path(this.path()).attr({"stroke-width":2,stroke:"#ff0000"});var a=this;this.raphaelobject.click(function(){console.log("raphaelobject on click"),a.select()}),this.raphaelobject.undrag(),this.raphaelobject.drag(function(b,c){a.start.x=this.data("startx")+b,a.start.y=this.data("starty")+c,a.stop.x=this.data("stopx")+b,a.stop.y=this.data("stopy")+c,a.update()},function(){this.data("startx",a.start.x),this.data("starty",a.start.y),this.data("stopx",a.stop.x),this.data("stopy",a.stop.y),Savage.mode="dragging"},function(){Savage.mode="none",console.log(Savage.mode)})},this.remove=function(){null!=this.startSelector&&this.startSelector.remove(),null!=this.stopSelector&&this.stopSelector.remove(),null!=this.glow&&this.glow.remove(),this.raphaelobject.remove(),delete this},this.draw(),this.toJSON=function(){return{type:"rectangle",start:this.start.toJSON(),stop:this.stop.toJSON(),color:this.color}},this.fromJSON=function(a){return this.start.fromJSON(a.start),this.stop.fromJSON(a.stop),this.color=a.color,this.update(),this}};